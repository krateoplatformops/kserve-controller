name: publish-helm-chart

on:
  push:
    tags: [ '[0-9]+.[0-9]+.[0-9]+' ]

jobs:
  publish-chart:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Get chart info
        id: chart
        run: |
          CONTROLLER_CHART_NAME=$(yq e '.name' charts/chart/Chart.yaml)
          CONTROLLER_CHART_VERSION=${GITHUB_REF#refs/tags/}
          echo "controller_chart_name=$CONTROLLER_CHART_NAME" >> $GITHUB_OUTPUT
          echo "controller_chart_version=$CONTROLLER_CHART_VERSION" >> $GITHUB_OUTPUT

          CRD_CHART_NAME=$(yq e '.name' charts/chart/Chart.yaml)
          CRD_CHART_VERSION=${GITHUB_REF#refs/tags/}
          echo "crd_chart_name=$CRD_CHART_NAME" >> $GITHUB_OUTPUT
          echo "crd_chart_version=$CRD_CHART_VERSION" >> $GITHUB_OUTPUT

      - name: Print Version
        run: |
          echo CRD_CHART_VERSION:${{steps.chart.outputs.crd_chart_version}}
          echo CONTORLLER_CHART_VERSION:${{steps.chart.outputs.controller_chart_version}}

      - name: Replace CHART_VERSION and APP_VERSION in charts/chart/Chart.yaml
        run: |
          sed -i 's/CHART_VERSION/${{ steps.chart.outputs.controller_chart_version }}/g' ./charts/chart/Chart.yaml
          sed -i 's/APP_VERSION/${{ steps.chart.outputs.controller_chart_version }}/g' ./charts/chart/Chart.yaml

      - name: Replace CHART_VERSION in charts/crd-chart/Chart.yaml
        run: sed -i 's/CHART_VERSION/${{ steps.chart.outputs.crd_chart_version }}/g' ./charts/crd-chart/Chart.yaml

      - name: Lint Helm crd chart
        run: helm lint ./charts/crd-chart
      - name: Lint Helm controller chart
        run: helm lint ./charts/chart

      - name: Package Helm chart
        run: |
          mkdir -p ./chartss
          helm package ./charts/crd-chart \
            --destination ./chartss \
            --version "${{ steps.chart.outputs.crd_chart_version }}" \
            --app-version "${{ steps.chart.outputs.crd_chart_version }}"
          helm package ./charts/chart \
            --destination ./chartss \
            --version "${{ steps.chart.outputs.controller_chart_version }}" \
            --app-version "${{ steps.chart.outputs.controller_chart_version }}"

      - name: Authenticate with GitHub App
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: Setup git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone gh-pages branch
        run: |
          git clone --branch gh-pages \
            https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/krateoplatformops/helm-charts.git gh-pages

      - name: Verify chart does not already exist
        run: |
          if [ -f "gh-pages/${{ steps.chart.outputs.crd_chart_name }}-${{ steps.chart.outputs.crd_chart_version }}.tgz" ]; then
            echo "Chart already exists"
            exit 1
          fi
          if [ -f "gh-pages/${{ steps.chart.outputs.controller_chart_name }}-${{ steps.chart.outputs.controller_chart_version }}.tgz" ]; then
            echo "Chart already exists"
            exit 1
          fi

      - name: Copy chart and update index
        run: |
          cp ./chartss/${{ steps.chart.outputs.crd_chart_name }}-${{ steps.chart.outputs.crd_chart_version }}.tgz gh-pages/
          cp ./chartss/${{ steps.chart.outputs.controller_chart_name }}-${{ steps.chart.outputs.controller_chart_version }}.tgz gh-pages/
          cd gh-pages
          helm repo index . --url https://krateoplatformops.github.io/helm-charts

      - name: Commit & push to gh-pages
        run: |
          cd gh-pages
          git add .
          git commit -m "Publish ${{ steps.chart.outputs.controller_chart_name }} v${{ steps.chart.outputs.controller_chart_version }} [skip ci]"
          git push origin gh-pages